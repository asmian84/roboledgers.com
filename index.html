<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoBookkeeping v3.2</title>
  <link rel="stylesheet" href="src/styles/styles.css">
  <link rel="stylesheet" href="src/styles/import-summary.css">

  <!-- AG Grid Community -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>

  <!-- SheetJS for Excel Import -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- PDF.js for PDF Import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Initialize PDF.js - disable worker for file:// protocol to avoid cross-origin issues
    if (window.location.protocol === 'file:') {
      // Disable worker for local file access
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = '';
      console.log('üìÑ PDF.js: Worker disabled for file:// protocol');
    } else {
      // Use worker for http/https
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      console.log('üìÑ PDF.js: Worker enabled');
    }
  </script>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Toast Notifications CSS -->
  <link rel="stylesheet" href="src/features/notifications/toast.css">
</head>

<body>

  <!-- Sidebar Navigation -->
  <aside id="sidebar" class="sidebar">

    <!-- Branding / Logo -->
    <div class="sidebar-brand">
      <img src="src/assets/logo.png" alt="RoboLedgers" class="brand-logo">
    </div>

    <nav class="sidebar-nav-content">

      <!-- GROUP: DAILY (Header Hidden) -->
      <div class="nav-group">
        <!-- DAILY Header Removed -->

        <a href="#/" class="nav-item" data-route="/">
          <i class="ph ph-house nav-icon"></i>
          <span class="nav-label">Home</span>
        </a>

        <a href="#/transactions" class="nav-item" data-route="/transactions">
          <i class="ph ph-wallet nav-icon"></i>
          <span class="nav-label">Transactions</span>
          <span class="nav-badge orange" id="sidebar-badge-txn" style="display:none;">0</span>
        </a>

        <a href="#/vendors" class="nav-item" data-route="/vendors">
          <i class="ph ph-storefront nav-icon"></i>
          <span class="nav-label">Vendors</span>
        </a>

        <a href="#/data-import" class="nav-item" data-route="/data-import">
          <i class="ph ph-download-simple nav-icon"></i>
          <span class="nav-label">Data Import</span>
          <span class="nav-badge blue" id="sidebar-badge-import" style="display:none;">0</span>
        </a>
      </div>

      <!-- GROUP: ANALYSIS -->
      <div class="nav-group">
        <div class="nav-group-header">ANALYSIS</div>

        <a href="#/reports" class="nav-item" data-route="/reports">
          <i class="ph ph-chart-line-up nav-icon"></i>
          <span class="nav-label">Reports</span>
        </a>

        <a href="#/accounts" class="nav-item" data-route="/accounts">
          <i class="ph ph-piggy-bank nav-icon"></i>
          <span class="nav-label">Accounts</span>
        </a>
      </div>

      <!-- GROUP: SYSTEM -->
      <div class="nav-group">
        <div class="nav-group-header">SYSTEM</div>

        <a href="#/settings" class="nav-item" data-route="/settings">
          <i class="ph ph-gear nav-icon"></i>
          <span class="nav-label">Settings</span>
        </a>

        <a href="#/audit" class="nav-item" data-route="/audit">
          <i class="ph ph-clipboard-text nav-icon"></i>
          <span class="nav-label">Audit Log</span>
        </a>
        <a href="#/team" class="nav-item" data-route="/team">
          <i class="ph ph-users nav-icon"></i>
          <span class="nav-label">Team</span>
        </a>
      </div>

    </nav>

    <!-- User Profile Footer -->
    <div class="sidebar-footer">
      <div class="user-profile-card">
        <div class="user-avatar-premium">
          <img src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" alt="User">
        </div>
        <div class="user-info-text">
          <div class="user-name">Alex Johnson</div>
          <div class="user-role">Premium Plan</div>
        </div>
        <button class="user-menu-btn">
          <i class="ph-bold ph-dots-three"></i>
        </button>
      </div>
    </div>
  </aside>

  <!-- Mobile Hamburger -->
  <button id="hamburger" class="hamburger" aria-label="Open menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Main Content Area -->
  <main class="main-content">

    <!-- Breadcrumb Bar -->
    <div id="breadcrumb" class="breadcrumb">
      <a href="#/" class="breadcrumb-item">Home</a>
    </div>

    <!-- Page Content (Router injects here) -->
    <div id="app" class="app-container">
      <!-- Route content will be injected here -->
      <div class="page loading">
        <p>Loading...</p>
      </div>
    </div>

  </main>

  <!-- Auth Modal (only modal allowed) -->
  <!-- Content rendered by auth-modal.js -->
  <div id="auth-modal" class="auth-modal" style="display: none;"></div>


  <!-- Scripts -->
  <script src="src/core/state.js"></script>
  <script src="src/core/router.js"></script>
  <script src="src/core/breadcrumb.js"></script>
  <script src="src/core/session.js"></script>
  <script src="src/components/auth-modal.js"></script>
  <script src="src/components/csv-import-modal.js"></script>
  <script src="src/components/add-transaction-modal.js"></script>

  <!-- Search Feature -->
  <script src="src/features/search/search-engine.js"></script>
  <script src="src/features/search/search-modal.js"></script>
  <script src="src/features/search/search-bar.js"></script>

  <!-- Keyboard Shortcuts -->
  <script src="src/features/shortcuts/keyboard-manager.js"></script>
  <script src="src/features/shortcuts/shortcuts-modal.js"></script>

  <!-- Notifications -->
  <script src="src/features/notifications/toast-manager.js"></script>

  <!-- Data Layer (MUST LOAD FIRST) -->
  <script src="src/core/system-log.js"></script> <!-- Load early for logging support -->
  <script src="src/data/utils.js"></script>
  <script src="src/data/models.js"></script>
  <script src="src/data/storage.js"></script>
  <script src="src/data/default-coa.js"></script>
  <!-- REMOVED CONFLICTING account-chart.js -->
  <script src="src/data/supabase.js"></script>

  <!-- NEW: Enhanced Import Services -->
  <script src="src/services/pdf-parser.js?v=20251221u"></script>
  <script src="src/services/bayesian-matcher.js"></script>
  <script src="src/services/upload-history.js"></script>

  <!-- Global Modal Service -->
  <script src="src/components/ui/modal-service.js"></script>

  <!-- Utils -->
  <script src="src/utils/smart-csv-parser.js"></script>
  <script src="src/utils/smart-matcher.js"></script>
  <script src="src/utils/vendor-engine.js"></script>
  <script src="src/utils/ai-test-suite.js"></script>
  <script src="src/utils/legacy-importer.js"></script>

  <!-- Account Manager (Multi-Account Support) -->
  <script src="src/features/accounts/account-manager.js"></script>
  <script src="src/features/accounts/account-switcher.js"></script>
  <script src="src/features/accounts/report-data-manager.js"></script>

  <!-- Page Modules -->
  <script src="src/pages/home.js"></script>
  <script src="src/pages/data-import.js?v=20251221ak2"></script>
  <script src="src/pages/profile.js"></script>
  <!-- <script src="src/pages/transactions-fixed.js"></script> LEGACY -->
  <script src="src/pages/transactions-grid.js?v=20251222grid"></script>
  <script src="src/pages/vendors.js?v=20251222robot"></script>
  <script src="src/pages/vendorDetail.js"></script>
  <script src="src/pages/accounts.js?v=20251221ap"></script>
  <script src="src/pages/accountDetail.js"></script>
  <script src="src/pages/reports.js"></script>
  <script src="src/pages/reconciliation.js"></script>
  <script src="src/pages/settings.js"></script>


  <!-- Vendor Pages -->
  <script src="src/utils/vendorMatcher.js"></script>
  <script src="src/pages/vendorNew.js"></script>
  <!-- Features -->
  <script src="src/features/uploads/pdf-import-service.js"></script>
  <script src="src/components/parser-settings-modal.js"></script>
  <script src="src/features/vendors/vendor-analysis.js"></script>
  <script src="src/components/vendor-analysis-modal.js"></script>
  <script src="src/pages/vendor-analysis-page.js"></script>
  <script src="src/data/seed-data.js"></script>



  <script>
    // Initialize application state
    const appState = createStore({
      currentUser: null,
      theme: 'light',
      sidebarOpen: false
    }, {
      storageKey: 'autobook_v3_state',
      persist: true
    });

    // ====================================
    // DATA LAYER INITIALIZATION
    // ====================================

    async function initializeDataLayer() {
      console.log('üíæüå± Initializing data layer...');

      try {
        // Check if database needs seeding
        const transactions = await window.storage.getTransactions();

        if (transactions.length === 0) {
          console.log('üå± No data found, seeding database...');
          const counts = await window.seedDatabase();
          console.log('‚úÖ Database seeded:', counts);
        } else {
          console.log(`‚úÖ Data loaded: ${transactions.length} transactions`);
        }

        // Load settings
        const settings = await window.storage.getSettings();
        console.log('‚öôÔ∏è Settings loaded:', settings);

        // Apply theme from settings
        if (settings.theme) {
          document.documentElement.setAttribute('data-theme', settings.theme);
          appState.setState({ theme: settings.theme });
        }

        // Update state with loaded data counts
        const vendors = await window.storage.getVendors();
        const accounts = await window.storage.getAccounts();

        console.log(`üìä Loaded: ${vendors.length} vendors, ${accounts.length} accounts`);

      } catch (error) {
        console.error('‚ùå Failed to initialize data layer:', error);
      }
    }

    // CLEANUP: Remove old localStorage keys from previous versions
    function cleanupOldStorage() {
      // Remove old 'transactions' key (we now use 'ab3_transactions')
      if (localStorage.getItem('transactions')) {
        console.log('üßπ Cleaning up old localStorage key: transactions');
        localStorage.removeItem('transactions');
      }
      // Remove any other legacy keys if needed
      if (localStorage.getItem('openingBalance')) {
        console.log('üßπ Migrating openingBalance to ab3_settings');
        const balance = localStorage.getItem('openingBalance');
        localStorage.removeItem('openingBalance');
        // Note: Opening balance will be managed through settings now
      }
    }

    // Run cleanup immediately
    cleanupOldStorage();

    // Initialize data when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeDataLayer);
    } else {
      // Already loaded
      setTimeout(initializeDataLayer, 0);
    }

    // Active nav updater
    function updateActiveNav(path) {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        const route = item.getAttribute('data-route');
        if (!route) return;

        // Exact match or starts with (for nested routes)
        if (route === path ||
          (path !== '/' && path.startsWith(route) && route !== '/')) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    // Update breadcrumb and nav on route change
    router.onChange((route) => {
      breadcrumbManager.update(route.path, route.params);
      updateActiveNav(route.path);
    });

    // Mobile sidebar toggle
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const sidebarClose = document.getElementById('sidebar-close');
    const mainContent = document.querySelector('.main-content');

    hamburger?.addEventListener('click', () => {
      sidebar.classList.add('open');
      appState.setState({ sidebarOpen: true });
    });

    sidebarClose?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      appState.setState({ sidebarOpen: false });
    });

    // Close sidebar when clicking outside on mobile
    mainContent?.addEventListener('click', () => {
      if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        appState.setState({ sidebarOpen: false });
      }
    });

    // ====================================
    // ROUTE REGISTRATION
    // ====================================

    // Home page renders inline for simplicity
    function renderHomePage() {
      return `
        <div class="page">
          <div class="page-header">
            <h1 class="page-title">Welcome to AutoBookkeeping v3.0</h1>
            <p class="page-subtitle">Your intelligent bookkeeping assistant</p>
          </div>

          <div class="dashboard-grid">
            <div class="card stat-card">
              <div class="stat-icon">üí∞</div>
              <h3>Total Transactions</h3>
              <p class="stat-value">0</p>
              <a href="#/transactions" class="stat-link">View all ‚Üí</a>
            </div>

            <div class="card stat-card">
              <div class="stat-icon">üè¢</div>
              <h3>Vendors</h3>
              <p class="stat-value">0</p>
              <a href="#/vendors" class="stat-link">Manage ‚Üí</a>
            </div>

            <div class="card stat-card">
              <div class="stat-icon">üìä</div>
              <h3>Accounts</h3>
              <p class="stat-value">0</p>
              <a href="#/accounts" class="stat-link">View chart ‚Üí</a>
            </div>

            <div class="card stat-card">
              <div class="stat-icon">üìà</div>
              <h3>Reports</h3>
              <p class="stat-value">Ready</p>
              <a href="#/reports" class="stat-link">Generate ‚Üí</a>
            </div>
          </div>

          <div class="card quick-actions">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
              <button class="btn-primary">üì• Import Transactions</button>
              <button class="btn-secondary">‚ûï Add Vendor</button>
              <button class="btn-secondary">üìã Create Rule</button>
            </div>
          </div>
        </div>
      `;
    }

    // Initialize session on app load
    Session.init().then(authenticated => {
      if (!authenticated) {
        console.log('No active session, will show login modal for protected routes');
      }
    });

    // Home/Dashboard
    router.register('/', () => {
      document.getElementById('app').innerHTML = renderHome();
    });

    router.register('/home', () => {
      window.breadcrumb.update([
        { label: 'Home', path: '/' }
      ]);
      window.renderHomePage();
    });

    router.register('/data-import', () => {
      window.breadcrumbManager.update('/data-import');
      window.renderDataImportPage();
    });

    // User Profile
    router.register('/profile', () => {
      document.getElementById('app').innerHTML = renderProfile();
    });

    // Transactions
    router.register('/transactions', () => {
      document.getElementById('app').innerHTML = renderTransactions();
    });

    // Vendors List
    router.register('/vendors', () => {
      const phtml = renderVendors();
      console.log('üß≠ Router: Received HTML for vendors. Length:', phtml ? phtml.length : 'NULL');
      document.getElementById('app').innerHTML = phtml;

      // Force init explicitly after DOM insertion
      setTimeout(() => {
        if (typeof initVendorsGrid === 'function') {
          console.log('üß≠ Router: Triggering Grid Init...');
          initVendorsGrid();
        }
      }, 50);
    });

    // New Vendor
    router.register('/vendors/new', () => {
      document.getElementById('app').innerHTML = renderVendorNew();
    });

    // Vendor Detail - Transactions Tab (default)
    router.register('/vendors/:vendorId', (route) => {
      document.getElementById('app').innerHTML = renderVendorDetail({ ...route.params, tab: 'transactions' });
    });

    // Vendor Detail - Transactions Tab
    router.register('/vendors/:vendorId/transactions', (route) => {
      document.getElementById('app').innerHTML = renderVendorDetail({ ...route.params, tab: 'transactions' });
    });

    // Vendor Detail - Analytics Tab
    router.register('/vendors/:vendorId/analytics', (route) => {
      document.getElementById('app').innerHTML = renderVendorDetail({ ...route.params, tab: 'analytics' });
    });

    // Vendor Detail - Settings Tab
    router.register('/vendors/:vendorId/settings', (route) => {
      document.getElementById('app').innerHTML = renderVendorDetail({ ...route.params, tab: 'settings' });
    });

    // Accounts (Chart of Accounts)
    router.register('/accounts', () => {
      document.getElementById('app').innerHTML = renderAccounts();
    });

    // Account Detail
    router.register('/accounts/:accountId', (route) => {
      document.getElementById('app').innerHTML = renderAccountDetail(route.params);
    });

    // Audit Log
    router.register('/audit', () => {
      if (window.AuditLogPage) {
        document.getElementById('app').innerHTML = window.AuditLogPage.render();
      }
    });

    // --- NEW: Vendor Analysis Module (RoboLedger Style) ---
    router.register('/vendor-analysis', () => {
      if (window.VendorAnalysisPage) {
        document.getElementById('app').innerHTML = window.VendorAnalysisPage.render();
      }
    });

    // Handle sub-route for drill down (though simpler hash logic in component handles it too)
    // We register it to ensure the router doesn't 404
    router.register('/vendor-analysis/:vendorName', () => {
      if (window.VendorAnalysisPage) {
        document.getElementById('app').innerHTML = window.VendorAnalysisPage.render();
      }
    });
    // -----------------------------------------------------

    // Reports - Dashboard
    router.register('/reports', () => {
      document.getElementById('app').innerHTML = renderReports({ report: 'dashboard' });
    });

    // Reports - Profit & Loss
    router.register('/reports/profit-loss', () => {
      document.getElementById('app').innerHTML = renderReports({ report: 'profit-loss' });
    });

    // Reports - Balance Sheet
    router.register('/reports/balance-sheet', () => {
      document.getElementById('app').innerHTML = renderReports({ report: 'balance-sheet' });
    });

    // Reports - Cash Flow
    router.register('/reports/cash-flow', () => {
      document.getElementById('app').innerHTML = renderReports({ report: 'cash-flow' });
    });

    // Reports - Vendor Analysis
    router.register('/reports/vendor-analysis', () => {
      document.getElementById('app').innerHTML = renderReports({ report: 'vendor-analysis' });
    });

    // Reports - Account Summary
    router.register('/reports/account-summary', () => {
      document.getElementById('app').innerHTML = renderReports({ report: 'account-summary' });
    });

    // Reports - Custom Builder
    router.register('/reports/custom', () => {
      document.getElementById('app').innerHTML = renderReports({ report: 'custom' });
    });

    // Bank Reconciliation
    router.register('/reconciliation', () => {
      document.getElementById('app').innerHTML = renderReconciliation();
    });

    // Upload History
    router.register('/uploads', () => {
      document.getElementById('app').innerHTML = renderUploads();
    });

    // Settings routes
    router.register('/settings', () => {
      document.getElementById('app').innerHTML = renderSettings({ panel: 'general' });
    });

    router.register('/settings/appearance', () => {
      document.getElementById('app').innerHTML = renderSettings({ panel: 'appearance' });
    });

    router.register('/settings/data', () => {
      document.getElementById('app').innerHTML = renderSettings({ panel: 'data' });
    });

    router.register('/settings/integrations', () => {
      document.getElementById('app').innerHTML = renderSettings({ panel: 'integrations' });
    });

    router.register('/settings/subscription', () => {
      document.getElementById('app').innerHTML = renderSettings({ panel: 'subscription' });
    });

    router.register('/settings/about', () => {
      document.getElementById('app').innerHTML = renderSettings({ panel: 'about' });
    });

    // Admin routes
    router.register('/team', () => {
      document.getElementById('app').innerHTML = `
        <div class="page">
          <div class="page-header">
            <h1 class="page-title">Team Management</h1>
          </div>
          <div class="card">
            <p>Team management features coming soon</p>
          </div>
        </div>
      `;
    });

    router.register('/subscription', () => {
      document.getElementById('app').innerHTML = renderSettings({ tab: 'subscription' });
    });

    router.register('/audit', () => {
      document.getElementById('app').innerHTML = `
        <div class="page">
          <div class="page-header">
            <h1 class="page-title">Audit Log</h1>
          </div>
          <div class="card">
            <div class="grid-placeholder">
              <div class="placeholder-icon">üìã</div>
              <p><strong>Audit log will be here</strong></p>
              <p>Track all user actions and system events</p>
            </div>
          </div>
        </div>
      `;
    });

    console.log('‚úÖ AutoBookkeeping v3.0 Navigation System initialized');
  </script>

</body>

</html>