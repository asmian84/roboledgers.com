<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboLedgers - AI-Powered Smart Bookkeeping</title>
    <meta name="description"
        content="Future-forward automated bookkeeping platform with intelligent transaction categorization and multi-account support">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel/CSV processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- AG Grid for interactive spreadsheet -->
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community@31.0.1/styles/ag-grid.min.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community@31.0.1/styles/ag-theme-alpine.min.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community@31.0.1/styles/ag-theme-alpine-dark.min.css">
    <script src="https://unpkg.com/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>

    <!-- Chart.js for Beautiful Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="super-modal.css?v=6">
    <!-- mobile.css removed as it does not exist -->
    <link rel="stylesheet" href="styles.css?v=6">
    <link rel="stylesheet" href="ticker.css?v=6">
    <link rel="stylesheet" href="dashboard.css?v=1">
</head>

<body data-theme="arctic-dawn">

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="modal-close" id="closeLoginModal">&times;</span>
            <div class="auth-container">
                <div class="auth-icon">🔐</div>
                <h2 id="authTitle">Welcome Back</h2>
                <form id="authForm">
                    <div class="input-group">
                        <input type="email" id="authEmail" placeholder="Email Address" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="authPassword" placeholder="Password" required>
                    </div>
                    <div id="authMessage" class="auth-message"></div>
                    <button type="submit" id="authSubmit" class="btn-primary full-width">Sign In</button>
                    <div class="auth-footer">
                        <a href="#" id="authToggle">New here? <b>Create Account</b></a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="app-sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">🤖</div>
                <h2>RoboLedgers</h2>
            </div>

            <div class="nav-group">
                <p class="nav-label">Main</p>
                <button class="nav-item active" data-target="dashboardSection" id="navDashboard">
                    <i class="fas fa-chart-pie"></i> Dashboard
                </button>
                <button class="nav-item" data-target="uploadSection" id="navUpload">
                    <i class="fas fa-cloud-upload-alt"></i> Upload
                </button>
                <button class="nav-item" data-target="reviewSection" id="navReview">
                    <i class="fas fa-table"></i> Transactions
                </button>
                <button class="nav-item" data-target="vendorsSection" id="navVendors"> <!-- Placeholder target -->
                    <i class="fas fa-store"></i> Vendors
                </button>
                <button class="nav-item" data-target="reportsSection" id="navReports"> <!-- Placeholder target -->
                    <i class="fas fa-file-invoice-dollar"></i> Reports
                </button>
            </div>

            <div class="nav-group">
                <p class="nav-label">Admin</p>
                <button class="nav-item" data-target="teamSection" id="navTeam">
                    <i class="fas fa-users"></i> Team
                </button>
                <button class="nav-item" data-target="subscriptionSection" id="navSubscription">
                    <i class="fas fa-credit-card"></i> Subscription
                </button>
                <button class="nav-item" data-target="auditSection" id="navAudit">
                    <i class="fas fa-history"></i> Audit Log
                </button>
            </div>

            <div class="sidebar-footer">
                <button class="nav-item-footer" id="settingsBtn" data-target="settingsSection">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <div class="nav-separator"></div>
                <!-- Reconciliation Link Added Here -->
                <button class="nav-item-footer" id="navReconciliation" data-target="reconciliationSection">
                    <i class="fas fa-check-double"></i> Reconciliation
                </button>

                <div class="user-profile-widget">
                    <div class="avatar-circle">AD</div>
                    <div class="user-info-mini">
                        <span class="name">Admin User</span>
                        <a href="#" onclick="AuthManager.signOut()" class="logout-link">Sign Out</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header for Mobile/Title -->
            <header class="mobile-header">
                <button id="mobileMenuBtn" class="icon-btn"><i class="fas fa-bars"></i></button>
                <h2 id="pageTitle">Dashboard</h2>
            </header>

            <!-- Step 0: Dashboard (New) -->
            <section id="dashboardSection" class="section active">
                <div class="welcome-banner">
                    <h1>Welcome back, <span class="highlight-text">Admin</span></h1>
                    <p>Here's what's happening with your books today.</p>
                </div>
                <!-- KPI Cards moved here from overlay -->
                <!-- Dashboard Layout -->
                <div class="dashboard-grid">
                    <!-- Top Row: KPI Cards -->
                    <div class="kpi-card glass-panel revenue-card">
                        <div class="icon-wrapper"><i class="fas fa-arrow-trend-up"></i></div>
                        <div class="kpi-info">
                            <h3>Revenue</h3>
                            <h2 id="kpiRevenue">$0.00</h2>
                        </div>
                    </div>

                    <div class="kpi-card glass-panel expense-card">
                        <div class="icon-wrapper"><i class="fas fa-arrow-trend-down"></i></div>
                        <div class="kpi-info">
                            <h3>Expenses</h3>
                            <h2 id="kpiExpenses">$0.00</h2>
                        </div>
                    </div>

                    <div class="kpi-card glass-panel profit-card">
                        <div class="icon-wrapper"><i class="fas fa-wallet"></i></div>
                        <div class="kpi-info">
                            <h3>Net Profit</h3>
                            <h2 id="kpiProfit">$0.00</h2>
                        </div>
                    </div>

                    <!-- Middle Row: Charts -->
                    <div class="chart-container glass-panel main-chart">
                        <h3>Income vs Expenses (Trend)</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container glass-panel donut-chart">
                        <h3>Top Expense Categories</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="expenseDonutChart"></canvas>
                        </div>
                    </div>

                    <!-- Bottom: AI Insight -->
                    <div class="insight-bar glass-panel full-width">
                        <div class="insight-icon">🤖</div>
                        <div class="insight-content">
                            <h4>AI Financial Analysis</h4>
                            <p id="aiInsightText">Analyzing your transactions...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 1: Upload Zone -->
            <section id="uploadSection" class="section">
                <div class="stats-bar" id="statsBar">

                    <span id="fileTypeIndicator" style="
                        margin-left: 1rem; 
                        padding: 0.2rem 0.6rem; 
                        border-radius: 999px; 
                        font-size: 0.75rem; 
                        font-weight: 700; 
                        text-transform: uppercase;
                        display: none;">
                    </span>
                </div>
                <div class="upload-container">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </div>

                        <h2>Drop your CSV file here</h2>
                        <p class="upload-subtitle">or click to browse</p>
                        <p class="upload-hint">Supports CSV bank statement files</p>
                        <input type="file" id="fileInput" accept=".csv" hidden>
                    </div>

                    <!-- Recent Files Explorer -->
                    <div class="file-explorer-container">
                        <div class="file-explorer-header">
                            <h3><i class="fas fa-history"></i> Recent Uploads</h3>
                        </div>
                        <ul id="fileList" class="file-list">
                            <!-- Populated by file-manager.js -->
                            <li class="empty-state">No recent files found.</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Step 2: Processing -->
            <section id="processingSection" class="section">
                <div class="processing-container">
                    <div class="processing-spinner">
                        <div class="spinner"></div>
                    </div>
                    <h2 id="processingText">Processing your file...</h2>
                    <p id="processingDetails" class="processing-details"></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </section>

            <!-- Step 3: Settings (Page Based) -->
            <section id="settingsSection" class="section">
                <div class="settings-page-container">
                    <h1 class="page-title">Settings</h1>

                    <div class="settings-grid-layout">

                        <!-- Section: Company Info -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h3>🏢 Company Information</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Company Name</label>
                                    <input type="text" id="companyNameInputPage" class="settings-input"
                                        placeholder="e.g. My Fast Company Ltd.">
                                    <small>Displayed on reports and transaction reviews.</small>
                                </div>
                                <div class="form-group">
                                    <label>Fiscal Year End</label>
                                    <input type="date" id="yearEndDate" class="settings-input">
                                </div>
                            </div>
                        </div>

                        <!-- Section: Data Management -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h3>💾 Data Management</h3>
                            </div>
                            <div class="card-body">
                                <label>Dictionaries & Lists</label>
                                <div class="action-list">
                                    <button id="settingsVendorDictBtn" class="btn-secondary full-width">
                                        <i class="fas fa-book"></i> Manage Vendor Dictionary
                                    </button>
                                    <button id="settingsAccountsBtn" class="btn-secondary full-width">
                                        <i class="fas fa-list"></i> View Chart of Accounts
                                    </button>
                                    <button id="settingsBankAccountsBtn" class="btn-secondary full-width">
                                        <i class="fas fa-university"></i> Manage Bank Accounts
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Appearance -->
                        <div class="settings-card full-width-card">
                            <div class="card-header">
                                <h3>🎨 Appearance</h3>
                            </div>
                            <div class="card-body">
                                <label>Color Theme</label>
                                <!-- Reusing the radio structure but adapted for page -->
                                <div class="theme-radio-group">
                                    <label class="theme-radio-option">
                                        <input type="radio" name="theme" value="cyber-night" checked>
                                        <div class="theme-content">
                                            <span class="theme-icon">🌃</span>
                                            <span class="theme-name">Cyber Night</span>
                                        </div>
                                    </label>
                                    <label class="theme-radio-option">
                                        <input type="radio" name="theme" value="arctic-dawn">
                                        <div class="theme-content">
                                            <span class="theme-icon">❄️</span>
                                            <span class="theme-name">Arctic Dawn</span>
                                        </div>
                                    </label>
                                    <label class="theme-radio-option">
                                        <input type="radio" name="theme" value="neon-forest">
                                        <div class="theme-content">
                                            <span class="theme-icon">🌲</span>
                                            <span class="theme-name">Neon Forest</span>
                                        </div>
                                    </label>
                                    <label class="theme-radio-option">
                                        <input type="radio" name="theme" value="royal-amethyst">
                                        <div class="theme-content">
                                            <span class="theme-icon">💎</span>
                                            <span class="theme-name">Royal Amethyst</span>
                                        </div>
                                    </label>
                                    <label class="theme-radio-option">
                                        <input type="radio" name="theme" value="sunset-horizon">
                                        <div class="theme-content">
                                            <span class="theme-icon">🌅</span>
                                            <span class="theme-name">Sunset Horizon</span>
                                        </div>
                                    </label>
                                    <label class="theme-radio-option">
                                        <input type="radio" name="theme" value="ocean-depths">
                                        <div class="theme-content">
                                            <span class="theme-icon">🌊</span>
                                            <span class="theme-name">Ocean Depths</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </section>

            <!-- Step 3: Transaction Review -->
            <section id="reviewSection" class="section">
                <!-- Empty State Message (Shown when no transactions) -->
                <div id="emptyTransactionState" class="empty-state-container">
                    <div class="empty-state-content">
                        <div class="empty-icon">📊</div>
                        <h2>NO data found, upload CSV to review transactions</h2>

                    </div>
                </div>

                <div id="reviewContent" style="display: none;">
                    <!-- Wrapper for Sticky Header -->
                    <div class="sticky-header-wrapper">
                        <div class="review-header">
                            <div class="review-title-center">
                                <h2>Transaction Review</h2>
                                <p id="reviewStats" class="review-stats"><span
                                        style="color:var(--text-secondary); opacity:0.7;">Ready to import CSV...</span>
                                </p>
                            </div>
                        </div>
                        <div class="review-actions-wrapper">
                            <!-- Top Row: Buttons -->
                            <div class="review-buttons">
                                <button id="reconciliationShortcutBtn" class="btn-secondary"
                                    onclick="document.getElementById('reconciliationPanel').scrollIntoView({behavior: 'smooth'})"
                                    title="Jump to Reconciliation">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                        <path d="M2 17l10 5 10-5"></path>
                                        <path d="M2 12l10 5 10-5"></path>
                                    </svg>
                                    Reconciliation
                                </button>
                                <button id="popoutBtn" class="btn-secondary" title="Open grid in new window">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                    Pop-Out
                                </button>
                                <button id="exportBtn" class="btn-secondary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Export XLS
                                </button>
                                <!-- NEW: Vendor Summary Button -->
                                <button id="vendorSummaryBtn" class="btn-secondary"
                                    title="View/Edit unique vendors in grid">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    Vendors in Grid
                                </button>
                                <button id="addDataBtn" class="btn-secondary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Add Data
                                </button>
                                <button id="startOverBtn" class="btn-secondary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="1 4 1 10 7 10"></polyline>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                    </svg>
                                    Start Over
                                </button>
                            </div>
                            <!-- Bottom Row: Search Controls -->
                            <div class="search-controls"
                                style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.75rem;">
                                <input type="text" id="gridQuickFilter" placeholder="Quick search..."
                                    style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: #ffffff; color: #1e293b; width: 200px; font-size: 0.9rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label for="refPrefixInput"
                                        style="font-size: 0.9rem; color: var(--text-secondary);">
                                        Ref#:
                                    </label>
                                    <input type="text" id="refPrefixInput" placeholder="CHQ" maxlength="5" style="
                                    padding: 0.4rem 0.6rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 4px;
                                    background: #ffffff;
                                    color: #1e293b;
                                    width: 70px;
                                    font-size: 0.9rem;
                                " />
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">

                                    <div class="input-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <label style="margin: 0; white-space: nowrap;">Account:</label>
                                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                                            <select id="bankAccountSelect" style="
                                        padding: 0.4rem 0.6rem;
                                        border: 1px solid var(--border-color);
                                        border-radius: 4px;
                                        background: #ffffff;
                                        color: #1e293b;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        min-width: 180px;
                                    ">
                                                <option value="">Select Account...</option>
                                            </select>

                                            <!-- NEW: Assign Grid Button (Hidden by default) -->
                                            <button id="assignGridToAccountBtn" class="btn-primary"
                                                title="Assign ALL current transactions to this account" style="
                                            display: none;
                                            padding: 0.4rem 0.8rem;
                                            font-size: 0.8rem;
                                            white-space: nowrap;
                                            background-color: var(--accent-color); 
                                        ">
                                                Link to Grid
                                            </button>

                                            <button id="editAccountBtn" class="btn-icon" title="Manage Accounts" style="
                                        background: transparent;
                                        border: 1px solid var(--border-color);
                                        border-radius: 4px;
                                        padding: 0.3rem;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: var(--text-secondary);
                                    ">
                                                ✏️
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions Bar (appears when rows selected) -->
                        <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                            <div class="bulk-actions-content">
                                <span class="selection-count">
                                    <strong id="selectedCount">0</strong> transactions selected
                                </span>

                                <div class="bulk-actions-controls">
                                    <select id="bulkAccountSelect" class="bulk-account-dropdown">
                                        <option value="">Assign Account...</option>
                                    </select>

                                    <button id="applyBulkAccount" class="bulk-action-btn primary">
                                        Apply to Selected
                                    </button>

                                    <button id="clearSelection" class="bulk-action-btn secondary">
                                        Clear Selection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End Sticky Header Wrapper -->

                    <div class="grid-container">
                        <div id="transactionGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
                    </div>

                </div>

                <!-- Reconciliation Section (Moved from Modal/Dashboard) -->
                <div id="reconciliationSection" class="section">
                    <div class="section-header">
                        <h1>Reconciliation</h1>
                        <p>Verify your bank balances against your records.</p>
                    </div>

                    <!-- KPIs Moved Here -->
                    <div class="kpi-row" style="margin-bottom: 2rem;">
                        <div class="kpi-card glass-panel profit-card">
                            <div class="icon-wrapper"><i class="fas fa-chart-line"></i></div>
                            <div class="kpi-info">
                                <h3>Net Profit (YTD)</h3>
                                <h2 id="kpiProfitRecon">$0.00</h2>
                            </div>
                        </div>
                        <div class="kpi-card glass-panel cash-card">
                            <div class="icon-wrapper"><i class="fas fa-coins"></i></div>
                            <div class="kpi-info">
                                <h3>Cash on Hand</h3>
                                <h2 id="kpiCashRecon">$0.00</h2>
                                <p class="trend neutral">Latest Balance</p>
                            </div>
                        </div>
                    </div>

                    <!-- Bank Reconciliation Panel (Moved from Review Section) -->
                    <div id="reconciliationPanel" class="reconciliation-panel">
                        <h3>🏦 Bank Reconciliation</h3>
                        <div class="reconciliation-grid">
                            <div class="reconciliation-section">
                                <h4>Opening Balance</h4>
                                <div class="reconciliation-input-group">
                                    <label>Expected</label>
                                    <input type="text" id="expectedOpeningBalance" placeholder="$0.00"
                                        class="currency-input">
                                </div>
                                <div class="reconciliation-value">
                                    <label>Calculated</label>
                                    <span id="calculatedOpeningBalance" class="calculated-value">$0.00</span>
                                </div>
                            </div>
                            <div class="reconciliation-section">
                                <h4>Ending Balance</h4>
                                <div class="reconciliation-input-group">
                                    <label>Expected</label>
                                    <input type="text" id="expectedEndingBalance" placeholder="$0.00"
                                        class="currency-input">
                                </div>
                                <div class="reconciliation-value">
                                    <label>Calculated</label>
                                    <span id="calculatedEndingBalance" class="calculated-value">$0.00</span>
                                </div>
                            </div>
                            <div class="reconciliation-section">
                                <h4>Transaction Totals</h4>
                                <div class="status-item">
                                    <label>Total Credits</label>
                                    <span id="totalCredits" class="calculated-value">$0.00</span>
                                </div>
                                <div class="status-item">
                                    <label>Total Debits</label>
                                    <span id="totalDebits" class="calculated-value">$0.00</span>
                                </div>
                            </div>
                            <div class="reconciliation-section">
                                <h4>Discrepancy</h4>
                                <div class="status-item">
                                    <label>Opening</label>
                                    <span id="openingDiscrepancy" class="discrepancy-value">$0.00</span>
                                </div>
                                <div class="status-item">
                                    <label>Ending</label>
                                    <span id="endingDiscrepancy" class="discrepancy-value">$0.00</span>
                                </div>
                                <div class="status-indicator" id="statusIndicator">
                                    <span class="status-icon">⚪</span>
                                    <span class="status-text">Enter expected balances</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    </div> <!-- End reviewContent -->

    <!-- Settings Modal (Deprecated - Moved to Page Section) -->
    <!-- 
                <div id="settingsModal" class="modal">
                     ... Deprecated ...
                </div> 
                -->
    </div>
    </div>

    <!-- Manage Accounts Modal -->
    <!-- Manage Accounts Modal (Standardized) -->
    <div id="manageAccountsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🏦 Manage Accounts</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" style="padding-bottom: 0;">
                <div id="accountsList" style="width: 100%;"></div>
            </div>
            <div class="modal-footer">
                <button id="addAccountBtn" class="btn-primary">
                    <i class="fas fa-plus"></i> Add Account
                </button>
                <button class="btn-secondary"
                    onclick="document.getElementById('manageAccountsModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Chart of Accounts Modal -->
    <div id="chartOfAccountsModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>Chart of Accounts</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Toolbar inside body but flush -->
                <div class="toolbar"
                    style="padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; background: var(--bg-secondary);">

                    <div class="search-wrapper" style="flex: 1; position: relative;">
                        <i class="fas fa-search"
                            style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);"></i>
                        <input type="text" id="chartSearch" placeholder="Search accounts..."
                            style="padding: 8px 10px 8px 32px; border: 1px solid var(--border-color); border-radius: 8px; width: 100%; box-sizing: border-box;">
                    </div>

                    <button id="addAccountChartBtn" class="btn-primary-small">
                        <i class="fas fa-plus"></i> Add Account
                    </button>
                    <button id="refreshChartBtn" class="btn-secondary-small" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div id="chartList" class="accounts-list-container" style="flex: 1; overflow-y: auto; padding: 0;">
                    <!-- Dynamic Content -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary"
                    onclick="document.getElementById('chartOfAccountsModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Account Modal -->
    <div id="accountFormModal" class="modal">
        <div class="modal-content small-modal"> <!-- small-modal if defined, or just modal-content -->
            <div class="modal-header">
                <h2 id="accountFormTitle">Add Account</h2>
                <button class="modal-close" id="closeAccountFormModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountFormId">

                    <div class="form-group">
                        <label for="accountName">Account Name *</label>
                        <input type="text" id="accountName" required placeholder="e.g., Main Chequing"
                            class="modal-input">
                    </div>

                    <div class="form-group">
                        <label for="accountType">Account Type *</label>
                        <select id="accountType" required class="modal-select">
                            <option value="CHEQUING">Chequing Account</option>
                            <option value="SAVINGS">Savings Account</option>
                            <option value="CREDIT_CARD">Credit Card</option>
                            <option value="LINE_OF_CREDIT">Line of Credit</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="accountOpeningBalance">Opening Balance</label>
                        <input type="number" id="accountOpeningBalance" step="0.01" value="0" placeholder="0.00"
                            class="modal-input">
                    </div>

                    <div class="form-group checkbox-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="accountIsDefault">
                            Set as default account
                        </label>
                    </div>

                    <!-- Form Actions moved to footer via JS or separate div, strictly footer is outside form usually but we can keep inside if needed for submit. 
                         Actually standard is footer has the buttons. We will put buttons in footer and attach click handler to submit form. -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelAccountForm">Cancel</button>
                <button type="button" class="btn-primary"
                    onclick="document.getElementById('accountForm').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))">Save
                    Account</button>
            </div>
        </div>
    </div>

    <!-- Reports Modal (Standardized) -->
    <!-- Reports Modal (Standardized) -->
    <div id="reportsModal" class="modal">
        <div class="modal-content category-modal">
            <div class="modal-header">
                <h2>📊 Financial Reports</h2>
                <button class="modal-close" id="closeReportsModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Report Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" data-report="income">Income Statement</button>
                    <button class="settings-tab" data-report="balance">Balance Sheet</button>
                    <button class="settings-tab" data-report="trial">Trial Balance</button>
                </div>

                <!-- Period Selector -->
                <div class="report-controls"
                    style="margin: 1rem 0; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <label style="font-size: 0.9rem; color: var(--text-secondary);">Period:</label>
                        <select id="reportPeriod" class="settings-select">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly" selected>Yearly</option>
                        </select>

                        <label style="font-size: 0.9rem; color: var(--text-secondary);">End Date:</label>
                        <input type="date" id="reportEndDate" class="settings-input" style="width: auto;">

                        <button id="generateReportBtn" class="btn-primary">Generate Report</button>
                    </div>
                </div>

                <!-- Report Display Area -->
                <div id="reportDisplay" class="report-display"
                    style="margin-top: 1rem; min-height: 400px; background: white; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 2rem;">Select parameters and
                        click Generate Report.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="exportReportPDF">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button class="btn-secondary"
                    onclick="document.getElementById('reportsModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>




    <!-- Vendor Manager Modal (Standardized) -->
    <div id="vendorModal" class="modal">
        <div class="modal-content large-modal"> <!-- Using large-modal variant for width -->
            <div class="modal-header">
                <h2>Vendor Dictionary</h2>
                <button id="closeVendorModal" class="modal-close">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Toolbar -->
                <div class="account-actions"
                    style="margin-bottom: 1rem; display: flex; gap: 10px; align-items: center;">
                    <button id="addVendorBtn" class="btn-primary-small">
                        <i class="fas fa-plus"></i> Add Vendor
                    </button>
                    <button id="bulkIndexBtn" class="btn-secondary-small">
                        <i class="fas fa-layer-group"></i> Bulk Index
                    </button>

                    <!-- Search Bar -->
                    <div class="search-wrapper" style="margin-left: auto; position: relative;">
                        <i class="fas fa-search"
                            style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);"></i>
                        <input type="text" id="vendorSearch" placeholder="Search vendors..."
                            style="padding: 8px 10px 8px 32px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; width: 250px;">
                    </div>
                </div>

                <!-- Bulk Import/Index Infos -->
                <div id="bulkIndexInfo" class="bulk-index-panel" style="display: none;">
                    <div class="bulk-upload-zone" id="bulkUploadZone">
                        <div class="icon">📂</div>
                        <h3>Drop Historical Files Here</h3>
                        <p>Process years of data to build a master vendor list</p>
                        <input type="file" id="bulkFileInput" multiple hidden>
                    </div>
                    <div id="bulkProgress" class="progress-container" style="display: none;">
                        <div class="progress-bar">
                            <div id="bulkProgressFill" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <p id="bulkProgressText">Processing...</p>
                    </div>
                    <div id="bulkResults" class="results-panel" style="display: none;"></div>
                </div>

                <!-- Vendor Grid -->
                <div id="vendorGrid" class="ag-theme-alpine" style="height: 100%; width: 100%; min-height: 400px;">
                </div>
            </div>

            <!-- Optional Footer if needed -->
            <!-- <div class="modal-footer"><button class="btn-secondary">Close</button></div> -->
        </div>
    </div>

    <!-- Drill Down Modal (Standardized) -->
    <div id="drillDownModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="drillDownModalTitle">Transactions for Vendor</h2>

                <!-- Drill Down Bulk Actions -->
                <div id="ddBulkActions" style="display: none; margin-left: 20px; align-items: center; gap: 10px;">
                    <span id="ddSelectedCount" style="color: var(--text-secondary); font-size: 0.9rem;">0
                        selected</span>
                    <select id="ddBulkVendorSelect"
                        style="max-width: 200px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <option value="">(Optional) Move to Vendor...</option>
                    </select>
                    <select id="ddBulkAccountSelect"
                        style="max-width: 200px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <option value="">(Optional) Assign Account...</option>
                    </select>
                    <button id="ddApplyBulkBtn" class="btn-primary"
                        style="padding: 4px 12px; font-size: 0.9rem;">Apply</button>
                </div>

                <button class="modal-close" id="closeDrillDownModal">&times;</button>
            </div>

            <div class="modal-body">
                <p class="section-desc" style="margin-bottom: 1rem;">
                    Review all transactions grouped under this vendor. You can move items to other accounts before
                    finalizing.
                </p>
                <!-- Grid Container -->
                <div id="drillDownGridContainer" class="ag-theme-alpine"
                    style="height: 100%; width: 100%; min-height: 500px;"></div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary"
                    onclick="document.getElementById('drillDownModal').style.display='none'; document.getElementById('drillDownModal').classList.remove('active');">Close</button>
            </div>
        </div>
    </div>
    <!-- 📊 FINANCIAL DASHBOARD OVERLAY -->
    <div id="financialDashboard" class="dashboard-overlay hidden">
        <div class="dashboard-container">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="header-left">
                    <h2>Executive Dashboard</h2>
                    <span class="live-badge">
                        <span class="pulse-dot"></span>
                        LIVE
                    </span>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" id="themeToggle" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="close-btn" id="closeDashboardBtn">&times;</button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="dashboard-content">
                <!-- KPI Grid -->
                <div class="kpi-grid">
                    <div class="kpi-card glass-panel revenue-card">
                        <div class="icon-wrapper"><i class="fas fa-arrow-trend-up"></i></div>
                        <div class="kpi-info">
                            <h3>Revenue</h3>
                            <h2 id="kpiRevenue">$0.00</h2>
                            <!-- <p class="trend positive">+12% vs last month</p> -->
                        </div>
                    </div>
                    <div class="kpi-card glass-panel expense-card">
                        <div class="icon-wrapper"><i class="fas fa-arrow-trend-down"></i></div>
                        <div class="kpi-info">
                            <h3>Expenses</h3>
                            <h2 id="kpiExpenses">$0.00</h2>
                            <!-- <p class="trend negative">+5% vs last month</p> -->
                        </div>
                    </div>
                    <div class="kpi-card glass-panel profit-card">
                        <div class="icon-wrapper"><i class="fas fa-wallet"></i></div>
                        <div class="kpi-info">
                            <h3>Net Profit</h3>
                            <h2 id="kpiProfit">$0.00</h2>
                            <!-- <p class="trend positive">+8% margin</p> -->
                        </div>
                    </div>
                    <div class="kpi-card glass-panel cash-card">
                        <div class="icon-wrapper"><i class="fas fa-coins"></i></div>
                        <div class="kpi-info">
                            <h3>Cash on Hand</h3>
                            <h2 id="kpiCash">$0.00</h2>
                            <p class="trend neutral">Latest Balance</p>
                        </div>
                    </div>
                </div>

                <!-- Main Charts Area -->
                <div class="charts-row">
                    <!-- Trend Chart (Large) -->
                    <div class="chart-container glass-panel trend-panel">
                        <div class="panel-header">
                            <h3>Income vs Expenses (YTD)</h3>
                        </div>
                        <div class="canvas-wrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <!-- Donut Chart (Side) -->
                    <div class="chart-container glass-panel donut-panel">
                        <div class="panel-header">
                            <h3>Top Expense Categories</h3>
                        </div>
                        <div class="canvas-wrapper">
                            <canvas id="expenseDonutChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- AI Insight Banner -->
                <div class="insight-banner glass-panel">
                    <div class="ai-icon">✨</div>
                    <div class="insight-content">
                        <h4>AI Financial Analyst</h4>
                        <p id="aiInsightText">Analyzing real-time transaction data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="theme-manager.js"></script>
    <script src="theme-radio-handler.js"></script>

    <!-- Core Models & Utils -->
    <script src="models.js"></script>
    <script src="utils.js"></script>
    <script src="storage.js"></script>
    <script src="session-manager.js"></script>
    <script src="undo-manager.js"></script>
    <script src="keyboard-handler.js"></script>
    <script src="settings-manager.js"></script>
    <script src="vendor-name-utils.js?v=2"></script>
    <script src="excel-exporter.js"></script>
    <script src="bulk-indexer.js"></script>
    <script src="search-service.js"></script>
    <script src="vendor-ai.js"></script>
    <script src="grid-stream.js"></script>
    <script src="reconciliation.js"></script>

    <!-- Logic Engines -->
    <script src="account-chart.js"></script>
    <script src="account-allocator.js"></script>
    <script src="bank-account-manager.js"></script>
    <script src="csv-parser.js"></script>
    <script src="vendor-matcher.js"></script>
    <script src="transaction-pipeline.js"></script>
    <script src="vendor-manager.js"></script>
    <script src="reports-engine.js"></script>
    <script src="dashboard-logic.js"></script>
    <script src="dashboard-logic.js"></script>
    <script src="vendor-import-export.js"></script>

    <!-- UI & Components -->
    <script src="transaction-grid.js?v=9"></script>
    <script src="vendor-summary-grid-fixed.js?v=1.29"></script>
    <script src="drill-down-grid-fixed.js?v=1.29"></script>
    <script src="grid-popout.js"></script>

    <!-- Cloud Sync -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="auth-manager.js"></script>

    <!-- Main App Entry -->
    <!-- Main App Entry -->
    <script src="nav-manager.js"></script>
    <script src="app.js?v=3.3"></script>

    <script>
        console.log('🔍 TEST: JavaScript is executing!');
        console.log('🔍 TEST: App loaded successfully.');
    </script>
    <!-- Vendor Summary Modal -->
    <div id="vendorSummaryModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>Vendors in Current Grid</h2>

                <button class="modal-close" id="closeVendorSummaryModal">&times;</button>
            </div>
            <!-- Matches VIG Body Structure -->
            <div class="modal-body" style="display: flex; flex-direction: column; height: calc(100% - 60px);">
                <!-- Correct ID for AG Grid and ensure full height -->
                <div id="vendorSummaryGridContainer" class="ag-theme-alpine"
                    style="height: 100%; width: 100%; min-height: 500px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="closeVendorSummaryBtn">Close</button>
            </div>
        </div>
    </div>
</body>

</html>