<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboLedgers - AI-Powered Smart Bookkeeping</title>
    <meta name="description"
        content="Future-forward automated bookkeeping platform with intelligent transaction categorization and multi-account support">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel/CSV processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- AG Grid for interactive spreadsheet -->
    <!-- AG Grid for interactive spreadsheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-grid.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>

    <!-- Chart.js for Beautiful Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="super-modal.css?v=6">
    <!-- mobile.css removed as it does not exist -->
    <link rel="stylesheet" href="styles.css?v=102">
    <link rel="stylesheet" href="modal-base.css?v=1">
    <link rel="stylesheet" href="ticker.css?v=6">
    <link rel="stylesheet" href="dashboard.css?v=1">
</head>

<body data-theme="arctic-dawn">

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="modal-close" id="closeLoginModal">&times;</span>
            <div class="auth-container">
                <div class="auth-icon">🔐</div>
                <h2 id="authTitle">Welcome Back</h2>
                <form id="authForm">
                    <div class="input-group">
                        <input type="email" id="authEmail" placeholder="Email Address" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="authPassword" placeholder="Password" required>
                    </div>
                    <div id="authMessage" class="auth-message"></div>
                    <button type="submit" id="authSubmit" class="btn-primary full-width">Sign In</button>
                    <div class="auth-footer">
                        <a href="#" id="authToggle">New here? <b>Create Account</b></a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="app-sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">🤖</div>
                <h2>RoboLedgers</h2>
            </div>

            <div class="nav-group">
                <p class="nav-label">Main</p>
                <button class="nav-item active" data-target="homeSection" id="navHome">
                    <i class="fas fa-home"></i> Home
                </button>
                <button class="nav-item" data-target="dashboardSection" id="navDashboard">
                    <i class="fas fa-chart-line"></i> Dashboard
                </button>
                <button class="nav-item" data-target="uploadSection" id="navUpload">
                    <i class="fas fa-cloud-upload-alt"></i> Upload
                </button>
                <button class="nav-item" data-target="reviewSection">
                    <i class="fas fa-list"></i> Transactions
                </button>
                <!-- Reconciliation moved here -->
                <button class="nav-item" id="navReconciliation" data-target="reconciliationSection">
                    <i class="fas fa-check-double" style="color: var(--success-color);"></i> Reconciliation
                </button>
                <button class="nav-item" data-target="vendors" id="navVendors">
                    <i class="fas fa-store"></i> Vendors
                </button>
                <button class="nav-item" data-target="reportsSection" id="navReports"> <!-- Placeholder target -->
                    <i class="fas fa-file-invoice-dollar"></i> Reports
                </button>
            </div>

            <div class="nav-group">
                <p class="nav-label">Admin</p>
                <button class="nav-item" data-target="teamSection" id="navTeam">
                    <i class="fas fa-users"></i> Team
                </button>
                <button class="nav-item" data-target="subscriptionSection" id="navSubscription">
                    <i class="fas fa-credit-card"></i> Subscription
                </button>
                <button class="nav-item" data-target="auditSection" id="navAudit">
                    <i class="fas fa-history"></i> Audit Log
                </button>
            </div>

            <!-- Sidebar Footer: Reconciliation & User -->
            <div class="sidebar-footer">
                <button class="nav-item-footer" data-target="settingsSection" id="settingsBtn">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <!-- User Profile (Mini) -->
                <div class="user-profile-btn">
                    <div class="avatar-circle">AD</div>
                    <div class="user-info-mini">
                        <span class="name">Admin User</span>
                        <a href="#" onclick="AuthManager.signOut()" class="logout-link">Sign Out</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header for Mobile/Title -->
            <header class="mobile-header">
                <button id="mobileMenuBtn" class="icon-btn"><i class="fas fa-bars"></i></button>
                <h2 id="pageTitle">Home</h2>
            </header>

            <!-- Step 0.1: Home Section (Welcome) -->
            <section id="homeSection" class="section active">
                <div class="welcome-banner">
                    <!-- Cleaned up: Removed redundant 'Welcome back Admin' to focus on centralized Hero -->

                    <!-- Dashboard / Home Layout (v2 Clean) -->
                    <div class="home-container">
                        <!-- Hero (Centered & Clean) -->
                        <div class="dashboard-hero slide-in"
                            style="text-align: center; margin-bottom: 3rem; display: flex; flex-direction: column; align-items: center;">
                            <h1 id="welcomeGreeting"
                                style="font-size: 3rem; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 2px;">
                                <span class="gradient-text">RoboLedgers</span>
                            </h1>
                            <p
                                style="font-size: 1.1rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto;">
                                The robust, AI-driven ledger for modern business. <br>
                                Current System Version: <span class="version-tag">v118</span>
                            </p>
                        </div>

                        <!-- Changelog Section -->
                        <div class="changelog-section fade-in-up">
                            <div class="changelog-header">
                                <h3><i class="fas fa-history"></i> Development Timeline</h3>
                                <span style="font-size: 0.85rem; color: var(--text-tertiary);">Daily Progress
                                    Report</span>
                            </div>

                            <!-- Dec 15 (Today) -->
                            <details class="version-item" open>
                                <summary class="version-summary">
                                    <span class="version-tag">Dec 15, 2025</span>
                                    <span class="version-date">Today</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </summary>
                                <div class="version-content">
                                    <ul>
                                        <li><strong>v118: Changelog Update</strong> - Refactored history to be strictly
                                            date-based.</li>
                                        <li><strong>v117: Home Redesign (Part 2)</strong> - Implemented Accordion UI.
                                        </li>
                                        <li><strong>v116: Logic Fix</strong> - Empty Transaction Review auto-redirects
                                            to Upload.</li>
                                        <li><strong>v115: UI Polish</strong> - "Wow" aesthetics upgrade (Gradient text).
                                        </li>
                                        <li><strong>v114: Dashboard Refactor</strong> - Split "Home" and "Dashboard".
                                        </li>
                                        <li><strong>v113: Themes</strong> - Added "Golden Hour" theme.</li>
                                    </ul>
                                </div>
                            </details>

                            <!-- Dec 14 -->
                            <details class="version-item">
                                <summary class="version-summary">
                                    <span class="version-tag">Dec 14, 2025</span>
                                    <span class="version-date">Sunday</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </summary>
                                <div class="version-content">
                                    <ul>
                                        <li><strong>v112: Settings UI</strong> - Cleaned up Appearance panel with grid
                                            layout.</li>
                                        <li><strong>v111: Bug Fix</strong> - Resolved navigation conflict in Upload
                                            Sidebar.</li>
                                        <li><strong>v110: UX</strong> - Added inline confirmation for session deletion.
                                        </li>
                                    </ul>
                                </div>
                            </details>

                            <!-- Dec 13 -->
                            <details class="version-item">
                                <summary class="version-summary">
                                    <span class="version-tag">Dec 13, 2025</span>
                                    <span class="version-date">Saturday</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </summary>
                                <div class="version-content">
                                    <ul>
                                        <li><strong>v109: Upload Center</strong> - Implemented Sidebar Navigation.</li>
                                        <li><strong>v108: Navigation</strong> - Fixed "Disappearing Content" bug.</li>
                                        <li><strong>v107: Admin</strong> - Added placeholders for Team/Subscription.
                                        </li>
                                    </ul>
                                </div>
                            </details>

                            <!-- Dec 12 -->
                            <details class="version-item">
                                <summary class="version-summary">
                                    <span class="version-tag">Dec 12, 2025</span>
                                    <span class="version-date">Foundation</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </summary>
                                <div class="version-content">
                                    <ul>
                                        <li><strong>v105-106: Auth</strong> - Integrated Google Sign-In & Forgot
                                            Password.</li>
                                        <li><strong>v104: UI</strong> - Initial Mobile Responsive Tweaks.</li>
                                    </ul>
                                </div>
                            </details>

                            <!-- Dec 10 -->
                            <details class="version-item">
                                <summary class="version-summary">
                                    <span class="version-tag">Dec 10, 2025</span>
                                    <span class="version-date">Core</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </summary>
                                <div class="version-content">
                                    <ul>
                                        <li><strong>v103: Multi-Account</strong> - Added `AccountManager` model.</li>
                                        <li><strong>v102: Data</strong> - Enhanced `BankAccount` class structures.</li>
                                    </ul>
                                </div>
                            </details>

                            <!-- Dec 05 -->
                            <details class="version-item">
                                <summary class="version-summary">
                                    <span class="version-tag">Dec 05, 2025</span>
                                    <span class="version-date">Alpha</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </summary>
                                <div class="version-content">
                                    <ul>
                                        <li><strong>v101: Mobile</strong> - Initial responsive grid layout.</li>
                                        <li><strong>v100: Parser</strong> - Improved CSV detection logic.</li>
                                    </ul>
                                </div>
                            </details>

                            <!-- Dec 01 -->
                            <details class="version-item">
                                <summary class="version-summary">
                                    <span class="version-tag">Dec 01, 2025</span>
                                    <span class="version-date">Inception</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </summary>
                                <div class="version-content">
                                    <ul>
                                        <li><strong>v1.0: Launch</strong> - Initial release of RoboLedgers.</li>
                                        <li><strong>Core:</strong> CSV/XLS Parsing Engine (SheetJS).</li>
                                        <li><strong>Core:</strong> LocalStorage Persistence Layer.</li>
                                        <li><strong>AI:</strong> Regex-based Vendor Classification.</li>
                                    </ul>
                                </div>
                            </details>

                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 0.2: Dashboard Section (Financial Overview) -->
            <section id="dashboardSection" class="section">
                <div class="dashboard-header" style="margin-bottom: 2rem;">
                    <h2>Financial Dashboard</h2>
                    <p>Real-time overview of your business performance.</p>
                </div>
                <!-- Placeholder for future charts -->
                <div class="empty-state-card">
                    <i class="fas fa-chart-line"></i>
                    <h3>Analytics Coming Soon</h3>
                </div>
            </section>

            <!-- Review Section (Separate Sibling for Grid) -->
            <section id="reviewSection" class="section">

                <div id="reviewContent">
                    <div class="review-header">
                        <div class="review-title-center">
                            <h2>Transaction Review</h2>
                            <p class="review-stats" id="reviewStats">0 transactions • $0.00 volume</p>
                        </div>
                        <div class="review-buttons">
                            <button id="popoutBtn" class="btn-secondary" title="Open grid in new window">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                Pop-Out
                            </button>
                            <button id="exportBtn" class="btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Export XLS
                            </button>
                            <!-- NEW: Vendor Summary Button -->
                            <button id="vendorSummaryBtn" class="btn-secondary"
                                title="View/Edit unique vendors in grid">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Vendors in Grid
                            </button>
                            <button id="addDataBtn" class="btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Add Data
                            </button>
                            <button id="startOverBtn" class="btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="1 4 1 10 7 10"></polyline>
                                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                </svg>
                                Start Over
                            </button>
                        </div>
                        <!-- Bottom Row: Search Controls -->
                        <div class="search-controls"
                            style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 0.75rem;">
                            <input type="text" id="gridQuickFilter" placeholder="Quick search..."
                                style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: #ffffff; color: #1e293b; width: 200px; font-size: 0.9rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="refPrefixInput" style="font-size: 0.9rem; color: var(--text-secondary);">
                                    Ref#:
                                </label>
                                <input type="text" id="refPrefixInput" placeholder="CHQ" maxlength="5" style="
                                    padding: 0.4rem 0.6rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 4px;
                                    background: #ffffff;
                                    color: #1e293b;
                                    width: 70px;
                                    font-size: 0.9rem;
                                " />
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">

                                <div class="input-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="margin: 0; white-space: nowrap;">Account:</label>
                                    <div style="display: flex; gap: 0.25rem; align-items: center;">
                                        <select id="bankAccountSelect" style="
                                        padding: 0.4rem 0.6rem;
                                        border: 1px solid var(--border-color);
                                        border-radius: 4px;
                                        background: #ffffff;
                                        color: #1e293b;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        min-width: 180px;
                                    ">
                                            <option value="">Select Account...</option>
                                        </select>

                                        <!-- NEW: Assign Grid Button (Hidden by default) -->
                                        <button id="assignGridToAccountBtn" class="btn-primary"
                                            title="Assign ALL current transactions to this account" style="
                                            display: none;
                                            padding: 0.4rem 0.8rem;
                                            font-size: 0.8rem;
                                            white-space: nowrap;
                                            background-color: var(--accent-color); 
                                        ">
                                            Link to Grid
                                        </button>

                                        <button id="editAccountBtn" class="btn-icon" title="Manage Accounts" style="
                                        background: transparent;
                                        border: 1px solid var(--border-color);
                                        border-radius: 4px;
                                        padding: 0.3rem;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: var(--text-secondary);
                                    ">
                                            ✏️
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions Bar (appears when rows selected) -->
                        <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                            <div class="bulk-actions-content">
                                <span class="selection-count">
                                    <strong id="selectedCount">0</strong> transactions selected
                                </span>

                                <div class="bulk-actions-controls">
                                    <select id="bulkAccountSelect" class="bulk-account-dropdown">
                                        <option value="">Assign Account...</option>
                                    </select>

                                    <button id="applyBulkAccount" class="bulk-action-btn primary">
                                        Apply to Selected
                                    </button>

                                    <button id="clearSelection" class="bulk-action-btn secondary">
                                        Clear Selection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-container summary-panel">
                        <div class="summary-card" style="margin-bottom: 1rem;">
                            <h3>Financial Overview</h3>
                            <!-- KPI Cards Row -->
                            <div class="kpi-row" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <div class="kpi-card glass-panel revenue-card" style="flex:1;">
                                    <div class="icon-wrapper"><i class="fas fa-arrow-trend-up"></i></div>
                                    <div class="kpi-info">
                                        <h3>Revenue</h3>
                                        <h2 id="kpiRevenue">$0.00</h2>
                                    </div>
                                </div>
                                <div class="kpi-card glass-panel expense-card" style="flex:1;">
                                    <div class="icon-wrapper"><i class="fas fa-arrow-trend-down"></i></div>
                                    <div class="kpi-info">
                                        <h3>Expenses</h3>
                                        <h2 id="kpiExpenses">$0.00</h2>
                                    </div>
                                </div>
                                <div class="kpi-card glass-panel net-card" style="flex:1;">
                                    <div class="icon-wrapper"><i class="fas fa-wallet"></i></div>
                                    <div class="kpi-info">
                                        <h3>Net Income</h3>
                                        <h2 id="kpiNet">$0.00</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Transaction Grid -->
                        <div id="transactionGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
                    </div>
                </div>

                <!-- Empty State (Hidden when data exists) -->
                <div id="emptyTransactionState" class="empty-state-large" style="display:none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No Transactions Found</h3>
                    <p>Upload a CSV file or add a transaction to get started.</p>
                    <button class="btn-primary" onclick="App.showSection('upload')">Go to Upload</button>
                </div>

            </section>

            <!-- Step 1: Upload Zone (Refactored with Sidebar) -->
            <section id="uploadSection" class="section">
                <!-- Using settings-layout to ensure 1:1 match with Settings Page -->
                <div class="settings-layout">
                    <!-- Sidebar -->
                    <div class="settings-sidebar">
                        <div class="settings-sidebar-header">
                            <h2>Upload Data</h2>
                        </div>
                        <nav class="settings-nav">
                            <!-- 1. Restore (Moved Up) -->
                            <button class="settings-nav-item active" onclick="App.switchUploadTab('restore')">
                                <i class="fas fa-history"></i> Restore Session
                            </button>
                            <!-- 2. CSV Upload (Moved Down) -->
                            <button class="settings-nav-item" onclick="App.switchUploadTab('csv')">
                                <i class="fas fa-file-csv"></i> CSV/XLS Upload
                            </button>
                            <!-- 3. Bank Feed -->
                            <button class="settings-nav-item" onclick="App.switchUploadTab('bank')">
                                <i class="fas fa-university"></i> Bank Feed
                            </button>
                        </nav>
                    </div>

                    <!-- Content Area -->
                    <div class="settings-content">

                        <!-- Panel: Restore (Default) -->
                        <div id="uploadTab-restore" class="settings-panel active" style="display: block;">
                            <div class="settings-card">
                                <div class="card-body">
                                    <div class="upload-header" style="text-align: center;"> <!-- Centered Header -->
                                        <h2>Restore Previous Session</h2>
                                        <p>Recover a previously uploaded file and its categorization state.</p>
                                    </div>
                                    <div id="versionExplorer">
                                        <!-- Version Explorer Rendered Here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: CSV Upload -->
                        <div id="uploadTab-csv" class="settings-panel">
                            <div class="settings-card">
                                <div class="card-body">
                                    <div class="upload-header" style="text-align: center;"> <!-- Centered Header -->
                                        <h2>Import Transactions</h2>
                                        <p>Upload your bank statements to begin categorization.</p>
                                    </div>

                                    <!-- Drop Zone (Cleaned Up) -->
                                    <div class="upload-zone" id="uploadZone" style="cursor: pointer;">
                                        <div class="upload-icon-wrapper">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                        </div>
                                        <h3>DROP YOUR CSV FILE HERE</h3>
                                        <!-- Removed "OR CLICK TO BROWSE" and Button as requested -->
                                        <span class="upload-hint">SUPPORTS CSV/XLS BANK STATEMENT FILES</span>
                                        <input type="file" id="fileInput" accept=".csv, .xls, .xlsx" hidden>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: Bank Feed -->
                        <div id="uploadTab-bank" class="settings-panel">
                            <div class="settings-card">
                                <div class="card-body">
                                    <div class="empty-state-content">
                                        <div class="empty-icon">🔨</div>
                                        <h3>Under Construction</h3>
                                        <p>Direct bank integration is coming soon.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </section>

            <!-- Admin Placeholders -->
            <section id="teamSection" class="section">
                <div class="empty-state-card">
                    <i class="fas fa-users"></i>
                    <h3>Team Management</h3>
                    <p>Invite and manage team members (Coming Soon).</p>
                </div>
            </section>

            <section id="subscriptionSection" class="section">
                <div class="empty-state-card">
                    <i class="fas fa-credit-card"></i>
                    <h3>Subscription</h3>
                    <p>Manage your billing and plan details (Coming Soon).</p>
                </div>
            </section>

            <section id="auditSection" class="section">
                <div class="empty-state-card">
                    <i class="fas fa-history"></i>
                    <h3>Audit Log</h3>
                    <p>View system activity and changes (Coming Soon).</p>
                </div>
            </section>
            <!-- Step 2: Processing -->
            <section id="processingSection" class="section">
                <div class="processing-container">
                    <div class="processing-spinner">
                        <div class="spinner"></div>
                    </div>
                    <h2 id="processingText">Processing your file...</h2>
                    <p id="processingDetails" class="processing-details"></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </section>

            <!-- Step 3: Settings (Page Based) -->
            <!-- Step 3: Settings (Sidebar Layout) -->
            <section id="settingsSection" class="section">
                <div class="settings-layout">
                    <!-- Sidebar -->
                    <div class="settings-sidebar">
                        <div class="settings-sidebar-header">
                            <h2>Settings</h2>
                        </div>
                        <nav class="settings-nav">
                            <button class="settings-nav-item active" data-panel="general">
                                <i class="fas fa-building"></i> General
                            </button>
                            <button class="settings-nav-item" data-panel="appearance">
                                <i class="fas fa-paint-brush"></i> Appearance
                            </button>
                            <button class="settings-nav-item" data-panel="data">
                                <i class="fas fa-database"></i> Data & Files
                            </button>
                            <button class="settings-nav-item" data-panel="subscription">
                                <i class="fas fa-credit-card"></i> Subscription
                            </button>
                            <button class="settings-nav-item" data-panel="about">
                                <i class="fas fa-info-circle"></i> About
                            </button>
                        </nav>
                    </div>

                    <!-- Content Panels -->
                    <div class="settings-content">

                        <!-- Panel: General -->
                        <div id="panel-general" class="settings-panel active">
                            <h3>🏢 Company Information</h3>
                            <div class="settings-card">
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Company Name</label>
                                        <input type="text" id="companyNameInputPage" class="settings-input"
                                            placeholder="e.g. My Fast Company Ltd.">
                                        <small>Displayed on reports and transaction reviews.</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Fiscal Year End</label>
                                        <input type="date" id="yearEndDate" class="settings-input">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: Appearance -->
                        <!-- Panel: Appearance -->
                        <div id="panel-appearance" class="settings-panel">
                            <h3>🎨 Interface Customization</h3>

                            <!-- Section 1: Display Preferences -->
                            <div class="settings-card" style="margin-bottom: 1.5rem;">
                                <div class="card-body">
                                    <h4
                                        style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Display Preferences</h4>

                                    <div class="settings-grid-3"
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                                        <!-- Scale -->
                                        <div class="setting-item">
                                            <label
                                                style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Platform
                                                Scale</label>
                                            <select id="uiScaleSelect" class="form-select" style="width: 100%;">
                                                <option value="1.1">110% (Larger)</option>
                                                <option value="1.0" selected>100% (Default)</option>
                                                <option value="0.9">90% (Compact)</option>
                                                <option value="0.8">80% (Small)</option>
                                            </select>
                                        </div>

                                        <!-- Grid Theme -->
                                        <div class="setting-item">
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Grid
                                                Theme</label>
                                            <select id="gridThemeSelect" class="form-select" style="width: 100%;">
                                                <option value="default" selected>Default</option>
                                                <option value="vanilla">Vanilla</option>
                                                <option value="classic">Classic</option>
                                                <option value="ledger">Ledger Pad</option>
                                                <option value="postit">Post-it Note</option>
                                                <option value="rainbow">Rainbow</option>
                                            </select>
                                        </div>

                                        <!-- Text Case -->
                                        <div class="setting-item">
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Text
                                                Case</label>
                                            <div class="btn-group" role="group" style="display: flex; gap: 0.5rem;">
                                                <button type="button" class="btn-group-item active" data-case="sentence"
                                                    style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-tertiary); border-radius: 6px; cursor: pointer;">Aa</button>
                                                <button type="button" class="btn-group-item" data-case="uppercase"
                                                    style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-tertiary); border-radius: 6px; cursor: pointer;">AA</button>
                                                <button type="button" class="btn-group-item" data-case="lowercase"
                                                    style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-tertiary); border-radius: 6px; cursor: pointer;">aa</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section 2: Color Theme -->
                            <div class="settings-card">
                                <div class="card-body">
                                    <h4
                                        style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Color Theme</h4>

                                    <div class="theme-radio-group"
                                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; max-width: 100%;">
                                        <label class="theme-radio-option">
                                            <input type="radio" name="theme" value="cyber-night" checked>
                                            <div class="theme-content">
                                                <span class="theme-icon">☁️</span>
                                                <span class="theme-name">Cyber Day</span>
                                            </div>
                                        </label>
                                        <label class="theme-radio-option">
                                            <input type="radio" name="theme" value="arctic-dawn">
                                            <div class="theme-content">
                                                <span class="theme-icon">❄️</span>
                                                <span class="theme-name">Arctic Dawn</span>
                                            </div>
                                        </label>
                                        <label class="theme-radio-option">
                                            <input type="radio" name="theme" value="neon-forest">
                                            <div class="theme-content">
                                                <span class="theme-icon">🌿</span>
                                                <span class="theme-name">Mint Fresh</span>
                                            </div>
                                        </label>
                                        <label class="theme-radio-option">
                                            <input type="radio" name="theme" value="royal-amethyst">
                                            <div class="theme-content">
                                                <span class="theme-icon">🌸</span>
                                                <span class="theme-name">Lavender Mist</span>
                                            </div>
                                        </label>
                                        <label class="theme-radio-option">
                                            <input type="radio" name="theme" value="sunset-horizon">
                                            <div class="theme-content">
                                                <span class="theme-icon">🍑</span>
                                                <span class="theme-name">Peach Dawn</span>
                                            </div>
                                        </label>
                                        <label class="theme-radio-option">
                                            <input type="radio" name="theme" value="golden-hour">
                                            <div class="theme-content">
                                                <span class="theme-icon">☀️</span>
                                                <span class="theme-name">Golden Hour</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: Data -->
                        <div id="panel-data" class="settings-panel">
                            <h3>💾 Data Management</h3>
                            <div class="settings-card">
                                <div class="card-body">
                                    <div class="action-list">
                                        <button id="settingsVendorDictBtn" class="btn-secondary full-width">
                                            <i class="fas fa-book"></i> Manage Vendor Dictionary
                                        </button>
                                        <button id="settingsAccountsBtn" class="btn-secondary full-width">
                                            <i class="fas fa-list"></i> View Chart of Accounts
                                        </button>
                                        <button id="settingsBankAccountsBtn" class="btn-secondary full-width">
                                            <i class="fas fa-university"></i> Manage Bank Accounts
                                        </button>
                                        <button id="settingsAuditBtn" class="btn-secondary full-width"
                                            onclick="App.showSection('audit')">
                                            <i class="fas fa-shield-alt"></i> View Audit Log
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: Subscription -->
                        <div id="panel-subscription" class="settings-panel">
                            <h3>💳 Subscription</h3>
                            <div class="settings-card">
                                <div class="card-body">
                                    <p>Manage your RoboLedgers plan.</p>
                                    <div class="empty-state-content">
                                        <div class="empty-icon" style="font-size: 2rem;">🚀</div>
                                        <p>Pro Plan Active</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel: About -->
                        <div id="panel-about" class="settings-panel">
                            <h3>ℹ️ About AutoBookkeeping</h3>
                            <div class="settings-card">
                                <div class="card-body">
                                    <p>Version 2.1.0 - Build 110</p>
                                    <p>&copy; 2025 RoboLedgers Inc.</p>
                                    <small>Built with ❤️ by Antigravity</small>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </section>

            <!-- Placeholder Sections -->
            <section id="vendors" class="section">
                <div class="empty-state-container">
                    <div class="empty-state-content">
                        <div class="empty-icon">🏪</div>
                        <h2>Vendor Management</h2>
                        <p>Advanced vendor tracking and consolidation.</p>
                        <div style="margin-top: 20px;">
                            <button class="btn-primary"
                                onclick="window.ModalManager ? ModalManager.open('VDMModal') : document.getElementById('VDMModal').style.display='flex'">Open
                                Vendor Dictionary</button>
                            <!-- Also trigger grid render if possible -->
                            <script>
                                // Small inline script to ensure grid renders if opened this way
                                // or rely on the button click opening the modal which might have listeners
                            </script>
                        </div>
                    </div>
                </div>
            </section>

            <section id="reportsSection" class="section">
                <div class="empty-state-container">
                    <div class="empty-state-content">
                        <div class="empty-icon">📈</div>
                        <h2>Financial Reports</h2>
                        <p>Comprehensive reporting suite.</p>
                        <button class="btn-primary"
                            onclick="document.getElementById('reportsModal').style.display='flex'">Open
                            Reports Panel</button>
                    </div>
                </div>
            </section>

            <section id="teamSection" class="section">
                <div class="empty-state-container">
                    <div class="empty-state-content">
                        <div class="empty-icon">👥</div>
                        <h2>Team Management</h2>
                        <p>Multi-user collaboration features coming soon.</p>
                    </div>
                </div>
            </section>

            <section id="subscriptionSection" class="section">
                <div class="empty-state-container">
                    <div class="empty-state-content">
                        <div class="empty-icon">💳</div>
                        <h2>Subscription</h2>
                        <p>Manage your RoboLedgers plan and billing.</p>
                    </div>
                </div>
            </section>

            <section id="auditSection" class="section">
                <!-- Audit Log Header -->
                <div class="card-header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3>🛡️ System Audit Log</h3>
                    <div>
                        <button class="btn-secondary" onclick="AuditManager.clearLogs()">Clear</button>
                        <button class="btn-primary" onclick="AuditManager.exportLogs()">Export CSV</button>
                    </div>
                </div>

                <!-- Log Container -->
                <div class="audit-container"
                    style="background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden;">
                    <div
                        style="background: var(--bg-secondary); padding: 10px; display: grid; grid-template-columns: 150px 100px 150px 1fr; gap: 10px; font-weight: 600; font-size: 0.9rem; border-bottom: 1px solid var(--border-color);">
                        <div>Time</div>
                        <div>Category</div>
                        <div>Action</div>
                        <div>Details</div>
                    </div>
                    <div id="auditLogList" style="max-height: 600px; overflow-y: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Step 3: Transaction Review -->
            <section id="reviewSection" class="section">
                <!-- Empty State Message (Shown when no transactions) -->
                <div id="emptyTransactionState" class="empty-state-container">
                    <div class="empty-state-content">
                        <div class="empty-icon">📊</div>
                        <h2>NO data found, upload CSV to review transactions</h2>

                    </div>
                </div>

                <div id="reviewContent" style="display: none;">
                    <!-- Wrapper for Sticky Header -->
                    <div class="sticky-header-wrapper">
                        <div class="review-header">
                            <div class="review-title-center">
                                <h2>Transaction Review</h2>
                                <p id="reviewStats" class="review-stats"><span
                                        style="color:var(--text-secondary); opacity:0.7;">Ready to import CSV...</span>
                                </p>
                            </div>
                        </div>
                        <div class="review-actions-wrapper">
                            <!-- Top Row: Buttons -->
                            <div class="review-buttons">

                                <button id="popoutBtn" class="btn-secondary" title="Open grid in new window">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                    Pop-Out
                                </button>
                                <button id="exportBtn" class="btn-secondary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Export XLS
                                </button>
                                <!-- NEW: Vendor Summary Button -->
                                <button id="vendorSummaryBtn" class="btn-secondary"
                                    title="View/Edit unique vendors in grid">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    Vendors in Grid
                                </button>
                                <button id="addDataBtn" class="btn-secondary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Add Data
                                </button>
                                <button id="startOverBtn" class="btn-secondary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="1 4 1 10 7 10"></polyline>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                    </svg>
                                    Start Over
                                </button>
                            </div>
                            <!-- Bottom Row: Search Controls -->
                            <div class="search-controls"
                                style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 0.75rem;">
                                <input type="text" id="gridQuickFilter" placeholder="Quick search..."
                                    style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background: #ffffff; color: #1e293b; width: 200px; font-size: 0.9rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label for="refPrefixInput"
                                        style="font-size: 0.9rem; color: var(--text-secondary);">
                                        Ref#:
                                    </label>
                                    <input type="text" id="refPrefixInput" placeholder="CHQ" maxlength="5" style="
                                    padding: 0.4rem 0.6rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 4px;
                                    background: #ffffff;
                                    color: #1e293b;
                                    width: 70px;
                                    font-size: 0.9rem;
                                " />
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">

                                    <div class="input-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <label style="margin: 0; white-space: nowrap;">Account:</label>
                                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                                            <select id="bankAccountSelect" style="
                                        padding: 0.4rem 0.6rem;
                                        border: 1px solid var(--border-color);
                                        border-radius: 4px;
                                        background: #ffffff;
                                        color: #1e293b;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        min-width: 180px;
                                    ">
                                                <option value="">Select Account...</option>
                                            </select>

                                            <!-- NEW: Assign Grid Button (Hidden by default) -->
                                            <button id="assignGridToAccountBtn" class="btn-primary"
                                                title="Assign ALL current transactions to this account" style="
                                            display: none;
                                            padding: 0.4rem 0.8rem;
                                            font-size: 0.8rem;
                                            white-space: nowrap;
                                            background-color: var(--accent-color); 
                                        ">
                                                Link to Grid
                                            </button>

                                            <button id="editAccountBtn" class="btn-icon" title="Manage Accounts" style="
                                        background: transparent;
                                        border: 1px solid var(--border-color);
                                        border-radius: 4px;
                                        padding: 0.3rem;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: var(--text-secondary);
                                    ">
                                                ✏️
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions Bar (appears when rows selected) -->
                        <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                            <div class="bulk-actions-content">
                                <span class="selection-count">
                                    <strong id="selectedCount">0</strong> transactions selected
                                </span>

                                <div class="bulk-actions-controls">
                                    <select id="bulkAccountSelect" class="bulk-account-dropdown">
                                        <option value="">Assign Account...</option>
                                    </select>

                                    <button id="applyBulkAccount" class="bulk-action-btn primary">
                                        Apply to Selected
                                    </button>

                                    <button id="clearSelection" class="bulk-action-btn secondary">
                                        Clear Selection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End Sticky Header Wrapper -->

                    <div class="grid-container">
                        <div id="transactionGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
                    </div>

                </div>
            </section>

            <!-- Reconciliation Section (Moved to Top Level) -->
            <div id="reconciliationSection" class="section">
                <div class="section-header">
                    <h1>Reconciliation</h1>
                    <p>Verify your bank balances against your records.</p>
                </div>

                <!-- KPIs Moved Here -->
                <div class="kpi-row" style="margin-bottom: 2rem;">
                    <div class="kpi-card glass-panel profit-card">
                        <div class="icon-wrapper"><i class="fas fa-chart-line"></i></div>
                        <div class="kpi-info">
                            <h3>Net Profit (YTD)</h3>
                            <h2 id="kpiProfitRecon">$0.00</h2>
                        </div>
                    </div>
                    <div class="kpi-card glass-panel cash-card">
                        <div class="icon-wrapper"><i class="fas fa-coins"></i></div>
                        <div class="kpi-info">
                            <h3>Cash on Hand</h3>
                            <h2 id="kpiCashRecon">$0.00</h2>
                            <p class="trend neutral">Latest Balance</p>
                        </div>
                    </div>
                </div>

                <!-- Bank Reconciliation Panel (Moved from Review Section) -->
                <div id="reconciliationPanel" class="reconciliation-panel">
                    <h3>🏦 Bank Reconciliation</h3>
                    <div class="reconciliation-grid">
                        <div class="reconciliation-section">
                            <h4>Opening Balance</h4>
                            <div class="reconciliation-input-group">
                                <label>Expected</label>
                                <input type="text" id="expectedOpeningBalance" placeholder="$0.00"
                                    class="currency-input">
                            </div>
                            <div class="reconciliation-value">
                                <label>Calculated</label>
                                <span id="calculatedOpeningBalance" class="calculated-value">$0.00</span>
                            </div>
                        </div>
                        <div class="reconciliation-section">
                            <h4>Ending Balance</h4>
                            <div class="reconciliation-input-group">
                                <label>Expected</label>
                                <input type="text" id="expectedEndingBalance" placeholder="$0.00"
                                    class="currency-input">
                            </div>
                            <div class="reconciliation-value">
                                <label>Calculated</label>
                                <span id="calculatedEndingBalance" class="calculated-value">$0.00</span>
                            </div>
                        </div>
                        <div class="reconciliation-section">
                            <h4>Transaction Totals</h4>
                            <div class="status-item">
                                <label>Total Credits</label>
                                <span id="totalCredits" class="calculated-value">$0.00</span>
                            </div>
                            <div class="status-item">
                                <label>Total Debits</label>
                                <span id="totalDebits" class="calculated-value">$0.00</span>
                            </div>
                        </div>
                        <div class="reconciliation-section">
                            <h4>Discrepancy</h4>
                            <div class="status-item">
                                <label>Opening</label>
                                <span id="openingDiscrepancy" class="discrepancy-value">$0.00</span>
                            </div>
                            <div class="status-item">
                                <label>Ending</label>
                                <span id="endingDiscrepancy" class="discrepancy-value">$0.00</span>
                            </div>
                            <div class="status-indicator" id="statusIndicator">
                                <span class="status-icon">⚪</span>
                                <span class="status-text">Enter expected balances</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Modal (Deprecated - Moved to Page Section) -->
            <!-- 
                <div id="settingsModal" class="modal">
                     ... Deprecated ...
                </div> 
                -->
    </div>
    </div>

    <!-- Manage Accounts Modal -->
    <!-- Manage Accounts Modal (Standardized) -->
    <div id="manageAccountsModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>🏦 Manage Accounts</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Toolbar (Matches VDM Standard) -->
                <!-- Toolbar (The WOW Standard) -->
                <div class="modal-toolbar"
                    style="flex-shrink: 0; padding: 1rem 1.5rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-bottom: 0;">

                    <!-- LEFT: Search (Optional for Accounts list, adding placeholder for future) -->
                    <!-- <div class="search-wrapper" style="flex: 1;"></div> -->

                    <!-- RIGHT: Actions -->
                    <div class="account-actions" style="display: flex; gap: 0.75rem; align-items: center;">
                        <button id="addAccountBtn" class="btn-primary"
                            style="display: flex; align-items: center; gap: 6px; padding: 0.6rem 1.2rem; font-weight: 500; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);">
                            <span style="font-size: 1.1rem;">➕</span> Add Bank Account
                        </button>
                    </div>
                </div>

                <div id="accountsList" style="width: 100%;"></div>
            </div>
            <!-- Footer removed for consistency (Close via Header) -->
        </div>
    </div>

    <!-- Chart of Accounts Modal -->
    <!-- Chart of Accounts Modal (REBUILT - VDM Pattern) -->
    <div id="chartOfAccountsModal" class="modal">
        <div class="modal-content large-modal"
            style="display: flex; flex-direction: column; overflow: hidden; resize: both;">

            <!-- Header -->
            <div class="modal-header">
                <h2>CHART OF ACCOUNTS</h2>
                <button class="modal-close">&times;</button>
            </div>

            <!-- Toolbar (WOW Pattern) -->
            <div class="modal-toolbar">
                <!-- LEFT: Search -->
                <div class="toolbar-left">
                    <input type="search" id="coaSearchInput" placeholder="Search accounts...">
                </div>

                <!-- RIGHT: Actions -->
                <div class="toolbar-right">
                    <button id="addAccountBtn" class="btn-primary">
                        <span style="font-size: 1.1rem;">➕</span> Add Account
                    </button>
                </div>
            </div>

            <!-- BODY: AG Grid Container -->
            <div class="modal-body" style="flex: 1; padding: 0; overflow: hidden;">
                <div id="coaGrid" class="ag-theme-alpine" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>


    <!-- Add/Edit Account Modal -->
    <div id="accountFormModal" class="modal">
        <div class="modal-content small-modal"> <!-- small-modal if defined, or just modal-content -->
            <div class="modal-header">
                <h2 id="accountFormTitle">Add Account</h2>
                <button class="modal-close" id="closeAccountFormModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountFormId">

                    <div class="form-group">
                        <label for="accountName">Account Name *</label>
                        <input type="text" id="accountName" required placeholder="e.g., Main Chequing"
                            class="modal-input">
                    </div>

                    <div class="form-group">
                        <label for="accountType">Account Type *</label>
                        <select id="accountType" required class="modal-select">
                            <option value="CHEQUING">Chequing Account</option>
                            <option value="SAVINGS">Savings Account</option>
                            <option value="CREDIT_CARD">Credit Card</option>
                            <option value="LINE_OF_CREDIT">Line of Credit</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="accountOpeningBalance">Opening Balance</label>
                        <input type="number" id="accountOpeningBalance" step="0.01" value="0" placeholder="0.00"
                            class="modal-input">
                    </div>

                    <div class="form-group checkbox-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="accountIsDefault">
                            Set as default account
                        </label>
                    </div>

                    <!-- Form Actions moved to footer via JS or separate div, strictly footer is outside form usually but we can keep inside if needed for submit. 
                         Actually standard is footer has the buttons. We will put buttons in footer and attach click handler to submit form. -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelAccountForm">Cancel</button>
                <button type="button" class="btn-primary"
                    onclick="document.getElementById('accountForm').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))">Save
                    Account</button>
            </div>
        </div>
    </div>

    <!-- Reports Modal (Standardized) -->
    <!-- Reports Modal (Standardized) -->
    <div id="reportsModal" class="modal">
        <div class="modal-content category-modal">
            <div class="modal-header">
                <h2>📊 Financial Reports</h2>
                <button class="modal-close" id="closeReportsModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Report Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" data-report="income">Income Statement</button>
                    <button class="settings-tab" data-report="balance">Balance Sheet</button>
                    <button class="settings-tab" data-report="trial">Trial Balance</button>
                </div>

                <!-- Period Selector -->
                <div class="report-controls"
                    style="margin: 1rem 0; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <label style="font-size: 0.9rem; color: var(--text-secondary);">Account:</label>
                        <select id="reportAccountSelect" class="settings-select" style="min-width: 150px;">
                            <option value="all">All Accounts</option>
                        </select>

                        <label style="font-size: 0.9rem; color: var(--text-secondary);">Period:</label>
                        <select id="reportPeriod" class="settings-select">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly" selected>Yearly</option>
                        </select>

                        <label style="font-size: 0.9rem; color: var(--text-secondary);">End Date:</label>
                        <input type="date" id="reportEndDate" class="settings-input" style="width: auto;">

                        <button id="generateReportBtn" class="btn-primary">Generate Report</button>
                    </div>
                </div>

                <!-- Report Display Area -->
                <div id="reportDisplay" class="report-display"
                    style="margin-top: 1rem; min-height: 400px; background: white; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 2rem;">Select parameters
                        and
                        click Generate Report.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="exportReportPDF">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button class="btn-secondary"
                    onclick="document.getElementById('reportsModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>




    <!-- Vendor Manager Modal (Standardized) -->
    <div id="VDMModal" class="modal">
        <div class="modal-content large-modal"> <!-- Using large-modal variant for width -->
            <div class="modal-header">
                <h2>Vendor Dictionary</h2>
                <button id="closeVendorModal" class="modal-close">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Toolbar (The WOW Standard) -->
                <div class="modal-toolbar"
                    style="flex-shrink: 0; padding: 1rem 1.5rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0;">

                    <!-- LEFT: Search -->
                    <div class="search-wrapper" style="position: relative; flex: 1; max-width: 400px;">
                        <span
                            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">🔍</span>
                        <input type="text" id="vendorSearch" placeholder="Search vendors by name..."
                            style="width: 100%; padding: 0.6rem 1rem 0.6rem 2.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    </div>

                    <!-- RIGHT: Actions -->
                    <div class="account-actions" style="display: flex; gap: 0.75rem; align-items: center;">
                        <button id="addVendorBtn" class="btn-primary"
                            style="display: flex; align-items: center; gap: 6px; padding: 0.6rem 1.2rem; font-weight: 500; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width: 1rem; height: 1rem;">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            Add Vendor
                        </button>
                        <button id="bulkIndexBtn" class="btn-secondary"
                            style="display: flex; align-items: center; gap: 6px; padding: 0.6rem 1.2rem; font-weight: 500;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="width: 1rem; height: 1rem;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Bulk Index
                        </button>
                    </div>
                </div>

                <!-- Bulk Import/Index Infos -->
                <div id="bulkIndexInfo" class="bulk-index-panel" style="display: none;">
                    <div class="bulk-upload-zone" id="bulkUploadZone">
                        <div class="icon">📂</div>
                        <h3>Drop Historical Files Here</h3>
                        <p>Process years of data to build a master vendor list</p>
                        <input type="file" id="bulkFileInput" multiple hidden>
                    </div>
                    <div id="bulkProgress" class="progress-container" style="display: none;">
                        <div class="progress-bar">
                            <div id="bulkProgressFill" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <p id="bulkProgressText">Processing...</p>
                    </div>
                    <div id="bulkResults" class="results-panel" style="display: none;"></div>
                </div>

                <!-- Vendor Grid -->
                <div id="vendorGrid" class="ag-theme-alpine" style="height: 100%; width: 100%; min-height: 400px;">
                </div>
            </div>

            <!-- Optional Footer if needed -->
            <!-- <div class="modal-footer"><button class="btn-secondary">Close</button></div> -->
        </div>
    </div>

    <!-- Drill Down Modal (Standardized) -->
    <div id="VSMModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="drillDownModalTitle">Transactions for Vendor</h2>

                <!-- Drill Down Bulk Actions -->
                <div id="ddBulkActions" style="display: none; margin-left: 20px; align-items: center; gap: 10px;">
                    <span id="ddSelectedCount" style="color: var(--text-secondary); font-size: 0.9rem;">0
                        selected</span>
                    <select id="ddBulkVendorSelect"
                        style="max-width: 200px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <option value="">(Optional) Move to Vendor...</option>
                    </select>
                    <select id="ddBulkAccountSelect"
                        style="max-width: 200px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <option value="">(Optional) Assign Account...</option>
                    </select>
                    <button id="ddApplyBulkBtn" class="btn-primary"
                        style="padding: 4px 12px; font-size: 0.9rem;">Apply</button>
                </div>

                <button class="modal-close" id="closeDrillDownModal">&times;</button>
            </div>

            <div class="modal-body">
                <p class="section-desc" style="margin-bottom: 1rem;">
                    Review all transactions grouped under this vendor. You can move items to other accounts before
                    finalizing.
                </p>
                <!-- Grid Container -->
                <div id="drillDownGridContainer" class="ag-theme-alpine"
                    style="height: 100%; width: 100%; min-height: 500px;"></div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary modal-close">Close</button>
            </div>
        </div>
    </div>


    <script src="theme-manager.js"></script>
    <script src="theme-radio-handler.js"></script>

    <!-- Core Models & Utils -->
    <script src="models.js"></script>
    <script src="utils.js"></script>
    <script src="storage.js"></script>
    <script src="audit-manager.js"></script>
    <script src="modal-manager.js"></script>
    <script src="modal-controller.js?v=1"></script>
    <script src="session-manager.js"></script>

    <script src="undo-manager.js"></script>
    <script src="keyboard-handler.js"></script>
    <script src="settings-manager.js"></script>
    <script src="vendor-name-utils.js?v=2"></script>
    <script src="excel-exporter.js"></script>
    <script src="bulk-indexer.js"></script>
    <script src="search-service.js"></script>
    <script src="vendor-ai.js"></script>
    <script src="grid-stream.js"></script>
    <script src="reconciliation.js"></script>

    <!-- Logic Engines -->
    <script src="account-chart.js?v=125"></script>
    <script src="account-allocator.js"></script>
    <script src="bank-account-manager.js"></script>
    <script src="csv-parser.js"></script>
    <script src="vendor-matcher.js"></script>
    <script src="transaction-pipeline.js"></script>
    <script src="vendor-manager.js"></script>
    <script src="reports-engine.js"></script>
    <script src="dashboard-logic.js"></script>


    <script src="vendor-import-export.js"></script>

    <!-- UI & Components -->
    <script src="transaction-grid.js?v=9"></script>
    <script src="vendor-summary-grid-fixed.js?v=1.29"></script>
    <script src="drill-down-grid-fixed.js?v=1.29"></script>
    <script src="grid-popout.js"></script>

    <!-- Cloud Sync -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="auth-manager.js"></script>

    <!-- Main App Entry -->
    <!-- Main App Entry -->
    <script src="app.js?v=122"></script>

    <script>
        console.log('🔍 TEST: JavaScript is executing!');
        console.log('🔍 TEST: App loaded successfully.');
    </script>
    <!-- Vendor Summary Modal -->
    <div id="VIGModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>Vendors in Current Grid</h2>

                <button class="modal-close" id="closeVendorSummaryModal">&times;</button>
            </div>
            <!-- Matches VIG Body Structure -->
            <div class="modal-body" style="display: flex; flex-direction: column; height: calc(100% - 60px);">
                <!-- Correct ID for AG Grid and ensure full height -->
                <div id="vendorSummaryGridContainer" class="ag-theme-alpine"
                    style="height: 100%; width: 100%; min-height: 500px;"></div>
            </div>

        </div>
    </div>


    <!-- Drill Down Modal (Standardized) -->
    <div id="VSMModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 id="drillDownModalTitle">Transactions for Vendor</h2>

                <!-- Drill Down Bulk Actions -->
                <div id="ddBulkActions" style="display: none; margin-left: 20px; align-items: center; gap: 10px;">
                    <span id="ddSelectedCount" style="color: var(--text-secondary); font-size: 0.9rem;">0
                        selected</span>
                    <select id="ddBulkVendorSelect"
                        style="max-width: 200px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <option value="">(Optional) Move to Vendor...</option>
                    </select>
                    <select id="ddBulkAccountSelect"
                        style="max-width: 200px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <option value="">(Optional) Assign Account...</option>
                    </select>
                    <button id="ddApplyBulkBtn" class="btn-primary"
                        style="padding: 4px 12px; font-size: 0.9rem;">Apply</button>
                </div>

                <button class="modal-close" id="closeDrillDownModal">&times;</button>
            </div>

            <div class="modal-body" style="display: flex; flex-direction: column; height: calc(100% - 60px);">
                <p class="section-desc" style="margin-bottom: 1rem; flex-shrink: 0;">
                    Review all transactions grouped under this vendor. You can move items to other accounts before
                    finalizing.
                </p>
                <!-- Grid Container -->
                <div id="drillDownGridContainer" class="ag-theme-alpine"
                    style="height: 100%; width: 100%; min-height: 500px; flex: 1;"></div>
            </div>


        </div>
    </div>

    <!-- Scripts -->
    <script src="drill-down-grid-fixed.js?v=1.29"></script>
</body>

</html>